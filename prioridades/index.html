<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../css/lib/bootstrap.min.css" />
    <link rel="stylesheet" href="../css/lib/bootstrap-grid.min.css" />
    <link rel="stylesheet" href="../css/lib/toastr.min.css" />
    <link rel="stylesheet" href="../css/prioridades.css" />
    <title>PRIORIDADES</title>
</head>

<body>

    <div class="navbar">
        <a href="http://chassis/dashboard/">FOLLOW UP</a>
    </div>

    <div class="text-center">
        <h1>PRIORIDADES</h1>
    </div>


    <div class="filters">
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">TIPO</span>
            </div>
            <select class="form-control" name="filter-line" id="filter-type"></select>
            <div class="input-group-append">
                <button class="btn" onclick="filterActivities()">FILTRAR</button>
            </div>
        </div>
    </div>


    <div class="table-wrapper" style="display: none;">
        <table class="table table-striped">
            <thead class="thead-dark"></thead>
            <tbody></tbody>
        </table>
    </div>



    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/jquery-ui.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script src="../lib/toastr.min.js"></script>
    <script src="../js/constants.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/NTGActivitie.js"></script>
    <script src="../js/scripts.js"></script>

    <script>

        // Fazer orderBy prioridade
        // Exibir apenas 5 primeiros

        var activities = [];
        var filteredActivities = [];

        window.onload = function () {
            generateFilters();
            getActivities(function (data) {
                activities = data;
                activities = filterByStatus(activities);
                activities = orderByPriority(activities);
                initialFilterType();
            });
        }

        function generateFilters() {
            var filterType = document.querySelector('#filter-type');
            TYPES.forEach(function (type) {
                if (type == 'ALL') return;
                var option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterType.appendChild(option);
            });
        }

        function generateTable(data) {
            document.querySelector('.table-wrapper').style.display = 'flex';
            var thead = document.querySelector('thead');
            var tbody = document.querySelector('tbody');
            $('thead').empty();
            $('tbody').empty();
            PRIORITY_TABLE.forEach(function (tc) {
                var th = document.createElement('th');
                th.textContent = tc.header;
                thead.appendChild(th);
            });
            data.map(function (d) {
                var tr = document.createElement('tr');
                PRIORITY_TABLE.map(function (tc) {
                    var td = document.createElement('td');
                    td.textContent = d[tc.field];
                    if (tc.field)
                        tr.appendChild(td);
                });
                createButtons(tr, tbody, d);
            });
        }

        function increasePriority(activity) {
            if (activity.priority > 0) {
                // $.get('http://localhost:59450/api/dashboard/increase/' + activity.id)
                $.get(SERVER + 'api/dashboard/increase/' + activity.id)
                    .done(function (response) {
                        toastr.success("ATIVIDADE ATUALIZADA COM SUCESSO");
                        getActivities(function (data) {
                            activities = data;
                            activities = filterByStatus(activities);
                            activities = orderByPriority(activities);
                            filterActivities();
                        })
                    })
                    .fail(function () { toastr.error("ERRO AO ATUALIZAR ATIVIDADE"); });
            }
        }

        function decreasePriority(activity) {
            // $.get('http://localhost:59450/api/dashboard/decrease/' + activity.id)
                $.get(SERVER + 'api/dashboard/decrease/' + activity.id)
                .done(function (response) {
                    toastr.success("ATIVIDADE ATUALIZADA COM SUCESSO");
                    getActivities(function (data) {
                        activities = data;
                        activities = filterByStatus(activities);
                        activities = orderByPriority(activities);
                        filterActivities();
                    })
                })
                .fail(function () { toastr.error("ERRO EM ATUALIZAR ATIVIDADE"); });
        }

        function filterActivities() {
            var filteredActivities = [];
            var selectedType = document.querySelector('#filter-type').value;
            filteredActivities = activities;
            if (selectedType != 'ALL')
                filteredActivities = filteredActivities.filter(function (a) { return a.type == selectedType });
            console.log(filteredActivities);
            generateTable(filteredActivities);
        }

        function initialFilterType() {
            var initialType = TYPES[1];
            filteredActivities = activities;
            filteredActivities = filteredActivities.filter(function (a) { return a.type == initialType });
            console.log(filteredActivities);
            generateTable(filteredActivities);
        }

        function filterByStatus(data) {
            return data.filter(function (a) { return a.projectStatus == 'STOPPED' || a.projectStatus == 'NOT STARTED' });
        }

        function orderByPriority(data) {
            return data.sort(function (a, b) { return a.priority - b.priority });
        }

        function getActivities(callback) {
            $.get(SERVER + '/api/dashboard', function (data) {
                var actv = [];
                data.map(function (d) {
                    actv.push(new NTGActivitie(d));
                });
                callback(actv);
            });
        }

        function openActivityDetails(data) {
            console.log(data);
        }

        function createButtons(tr, tbody, d) {
            var addButton = document.createElement('button');
            addButton.insertAdjacentHTML('afterbegin', '<img class="icon" src="../css/icons/chevron-top.svg" />');
            var removeButton = document.createElement('button');
            removeButton.insertAdjacentHTML('afterbegin', '<img class="icon" src="../css/icons/chevron-bottom.svg" />');
            addButton.className = 'btn btn-success add-button';
            addButton.onclick = function () { increasePriority(d) };
            tr.appendChild(addButton);
            removeButton.className = 'btn btn-danger add-button';
            removeButton.onclick = function () { decreasePriority(d) };
            tr.appendChild(removeButton);
            tbody.appendChild(tr);
        }


    </script>

</body>

</html>